<!--*INDEXED*-->
<html>
<head>
    <!-- meta things -->
    <meta name=viewport content="width=device-width, initial-scale=1">
    <title>Note - Nathan Higley</title>
    <link rel="canonical" href="https://nathanhigley.com" />
    <!-- end meta things -->
  
    <!-- favicon code -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../images/favicon-16x16.png">
    <link rel="manifest" href="../../images/site.webmanifest">
    <link rel="shortcut icon" href="../../images/favicon.ico">
    <meta name="msapplication-TileColor" content="#2b5797">
    <meta name="msapplication-config" content="../../images/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <!-- end favicon code -->
  
    <!-- style sheets -->
    <link rel="stylesheet" href="../../style-sheets/styles.css">
    <link rel="stylesheet" href="../../style-sheets/bootstrap-grid.css">
    <link rel="stylesheet" href="../../style-sheets/bootstrap-grid.min.css">
    <link rel="stylesheet" href="../../style-sheets/bootstrap-reboot.css">
    <link rel="stylesheet" href="../../style-sheets/bootstrap-reboot.min.css">
    <link rel="stylesheet" href="../../style-sheets/fontawesome.css">
    <link rel="stylesheet" href="../../style-sheets/fonts.css">
    <!-- end style sheets -->
    <link rel="stylesheet" href="css/boostnote.css">
    <link rel="stylesheet" href="css/dracula.css">
    <link rel="stylesheet" href="css/katex.min.css">
    <link rel="stylesheet" href="css/codemirror.css">
    <link rel="stylesheet" href="css/main.min.css">
</head>
<body class="note-body">

    <!-- nav code -->
    <nav>
        <ul class="note-header"> 
            <li class="nav"><a class="nav" href="../../index.html#home"><i class="fas fa-igloo"></i><span class="labels"> Home</span></a></li>
            <li class="nav"><a class="nav" href="../../index.html#about"><i class="fas fa-info-circle"></i><span class="labels"> About</span></a></li>
            <li class="nav"><a class="nav" href="../../index.html#work"><i class="fas fa-desktop"></i><span class="labels"> Work</span></a></li>
            <li class="nav"><a class="nav" href="../../index.html#contact"><i class="fas fa-address-card"></i><span class="labels"> Contact</span></a></li>
            <li class="nav"><a class="nav" href="../notes.html"><i class="fas fa-sticky-note"></i><span class="labels"> Notes</span></a></li>
        </ul>
    </nav>
    <!-- end nav code -->
    <div class="d-flex" >
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-12 note-spacer"></div>
          <div class="col-lg-12"><h1 id="Arch-Linux-w-Fully-Encrypted-Filesystem" data-line="0">Arch Linux w/ Fully Encrypted Filesystem</h1><p data-line="2">This guide will show step by step how to create a clean Arch Linux install with a fully encrypted filesystem.  This means that even the boot partition will be encrypted.  The only unencrypted partition on the disk will be the EFI partition which could be configured later to use secure boot.</p>
<p data-line="4">Assuming an EFI system with GPT disk.</p>
<h3 id="Basic-Install-Stuff" data-line="6">Basic Install Stuff</h3>
<p data-line="8">Make sure you can hit the outside world:</p>
<blockquote data-line="9">
<p data-line="9">ping google.com</p>
</blockquote>
<p data-line="11">If not run dhcpcd:</p>
<blockquote data-line="12">
<p data-line="12">dhcpcd</p>
</blockquote>
<p data-line="14">Set the time:</p>
<blockquote data-line="15">
<p data-line="15">timedatectl set-ntp true</p>
</blockquote>
<h3 id="Setup-the-Disk-where-the-magic-happens" data-line="17">Setup the Disk (where the magic happens)</h3>
<h4 id="Create-Partitions" data-line="19">Create Partitions</h4>
<p data-line="20">Assuming /dev/sda is the device you want to install to.</p>
<blockquote data-line="22">
<p data-line="22">parted /dev/sda<br>
mklabel gpt</p>
<p data-line="25">mkpart ESP fat32 1MiB 200MiB<br>
set 1 boot on<br>
name 1 efi</p>
<p data-line="29">mkpart primary 800MiB 100%<br>
set 3 lvm on<br>
name 3 lvm<br>
print</p>
</blockquote>
<h4 id="Setup-LUKS" data-line="34">Setup LUKS</h4>
<p data-line="36">Encrypt the partition</p>
<blockquote data-line="37">
<p data-line="37">cryptsetup luksFormat --type luks1 /dev/sda2</p>
</blockquote>
<p data-line="39">Open the partition</p>
<blockquote data-line="40">
<p data-line="40">cryptsetup open /dev/sda2 encrypted-lvm</p>
</blockquote>
<h4 id="Setup-LVM" data-line="42">Setup LVM</h4>
<p data-line="43">Create a Physical Volume</p>
<blockquote data-line="44">
<p data-line="44">pvcreate /dev/mapper/encrypted-lvm</p>
</blockquote>
<p data-line="46">Create a volume group</p>
<blockquote data-line="47">
<p data-line="47">vgcreate arch /dev/mapper/encrypted-lvm</p>
</blockquote>
<p data-line="49">Create logical volumes in group</p>
<blockquote data-line="50">
<p data-line="50">lvcreate -n home -L &lt;SIZE&gt;G arch<br>
lvcreate -n root -L &lt;SIZE&gt;G arch<br>
lvcreate -n boot -L 600M arch<br>
lvcreate -n swap -L &lt;SIZE&gt; -C y arch</p>
</blockquote>
<h4 id="Format-Partitions" data-line="55">Format Partitions</h4>
<p data-line="56">Format the EFI partition</p>
<blockquote data-line="57">
<p data-line="57">mkfs.fat -F32 /dev/sda1</p>
</blockquote>
<p data-line="59">Format the Volume Groups</p>
<blockquote data-line="60">
<p data-line="60">mkfs.ext4 -L boot /dev/mapper/arch-boot<br>
mkfs.btrfs -L root /dev/mapper/arch-root<br>
mkfs.btrfs -L home /dev/mapper/arch-home<br>
mkswap /dev/mapper/arch-swap</p>
</blockquote>
<h3 id="Mount-Partitions" data-line="65">Mount Partitions</h3>
<p data-line="67">Configure Swap</p>
<blockquote data-line="68">
<p data-line="68">swapon /dev/mapper/arch-swap<br>
swapon -a; swapon -s</p>
</blockquote>
<p data-line="71">Mount the filesystem</p>
<blockquote data-line="72">
<p data-line="72">mount /dev/mapper/arch-root /mnt<br>
mkdir -p /mnt/{home,boot}<br>
mount /dev/mapper/boot /mnt/boot<br>
mount /dev/mapper/arch-home /mnt/home<br>
mkdir /mnt/boot/efi<br>
mount /dev/sda1 /mnt/boot/efi</p>
</blockquote>
<p data-line="79">Check how everything is mounted</p>
<blockquote data-line="80">
<p data-line="80">lsblk -f</p>
</blockquote>
<h3 id="Install-the-Base-System" data-line="82">Install the Base System</h3>
<p data-line="83">Install base packages</p>
<blockquote data-line="84">
<p data-line="84">pacstrap /mnt base efibootmgr btrfs-progs grub linux-zen linux-firmware lvm2</p>
</blockquote>
<p data-line="86">Generate Fstab</p>
<blockquote data-line="87">
<p data-line="87">genfstab -U -p /mnt &gt; /mnt/etc/fstab</p>
</blockquote>
<p data-line="89">Chroot into new install</p>
<blockquote data-line="90">
<p data-line="90">arch-chroot /mnt /bin/bash</p>
</blockquote>
<h3 id="Configure-the-Install" data-line="92">Configure the Install</h3>
<h4 id="Normal-Things" data-line="94">Normal Things</h4>
<p data-line="95">Set the time zone</p>
<blockquote data-line="96">
<p data-line="96">ln -sf /usr/share/zoneinfo/Region/City /etc/localtime<br>
hwclock --systohc</p>
</blockquote>
<p data-line="99">Localization<br>
Uncomment “en_US.UTF-8 UTF-8” from /etc/locale.gen</p>
<blockquote data-line="101">
<p data-line="101">locale-gen<br>
echo “LANG=en_US.UTF-8” &gt; /etc/locale.conf</p>
</blockquote>
<p data-line="104">Set the hostname</p>
<blockquote data-line="105">
<p data-line="105">echo “hostname” &gt; /etc/hostname</p>
</blockquote>
<p data-line="107">Edit /etc/hosts to</p>
<pre class="code CodeMirror cm-s-dracula" data-line="108">        <span class="filename"></span>
        <span class="lineNumber CodeMirror-gutters"><span class="CodeMirror-linenumber">1</span><span class="CodeMirror-linenumber">2</span><span class="CodeMirror-linenumber">3</span></span>
        <code class="">127.0.0.1   localhost
::1         localhost
127.0.1.1   hostname.localdomain    hostname
</code>
      <i><button class="clipboardButton"><svg width="13" height="13" viewBox="0 0 1792 1792"><path d="M768 1664h896v-640h-416q-40 0-68-28t-28-68v-416h-384v1152zm256-1440v-64q0-13-9.5-22.5t-22.5-9.5h-704q-13 0-22.5 9.5t-9.5 22.5v64q0 13 9.5 22.5t22.5 9.5h704q13 0 22.5-9.5t9.5-22.5zm256 672h299l-299-299v299zm512 128v672q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-160h-544q-40 0-68-28t-28-68v-1344q0-40 28-68t68-28h1088q40 0 68 28t28 68v328q21 13 36 28l408 408q28 28 48 76t20 88z"></path></svg></button></i></pre><h4 id="Encryption-Unlock" data-line="114">Encryption Unlock</h4>
<p data-line="116">Generate a keyfile for the root filesystem:</p>
<blockquote data-line="117">
<p data-line="117">dd bs=512 count=4 if=/dev/random of=/root/encrypted-lvm.keyfile iflag=fullblock<br>
chmod 000 /root/encrypt-lvm.keyfile<br>
cryptsetup -v luksAddKey /dev/sda2 /root/encrypted-lvm.keyfile</p>
</blockquote>
<p data-line="121">Edit /etc/mkinitcpio.conf and add keyboard keymap encrypt lvm2 to hooks and add keyfile to files</p>
<pre class="code CodeMirror cm-s-dracula" data-line="122">        <span class="filename"></span>
        <span class="lineNumber CodeMirror-gutters"><span class="CodeMirror-linenumber">1</span><span class="CodeMirror-linenumber">2</span></span>
        <code class="">FILES=(/root/encrypted-lvm.keyfile)
HOOKS=(base udev autodetect keyboard keymap consolefont modconf block encrypt lvm2 filesystems fsck)
</code>
      <i><button class="clipboardButton"><svg width="13" height="13" viewBox="0 0 1792 1792"><path d="M768 1664h896v-640h-416q-40 0-68-28t-28-68v-416h-384v1152zm256-1440v-64q0-13-9.5-22.5t-22.5-9.5h-704q-13 0-22.5 9.5t-9.5 22.5v64q0 13 9.5 22.5t22.5 9.5h704q13 0 22.5-9.5t9.5-22.5zm256 672h299l-299-299v299zm512 128v672q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-160h-544q-40 0-68-28t-28-68v-1344q0-40 28-68t68-28h1088q40 0 68 28t28 68v328q21 13 36 28l408 408q28 28 48 76t20 88z"></path></svg></button></i></pre><p data-line="127">Then generate the initramfs image:</p>
<blockquote data-line="128">
<p data-line="128">mkinitcpio -p linux-zen</p>
</blockquote>
<p data-line="130">Secure the embedded keyfile:</p>
<blockquote data-line="131">
<p data-line="131">chmod 600 /boot/initramfs-linux*</p>
</blockquote>
<p data-line="133">Configure grub, edit /etc/default/grub:</p>
<pre class="code CodeMirror cm-s-dracula" data-line="134">        <span class="filename"></span>
        <span class="lineNumber CodeMirror-gutters"><span class="CodeMirror-linenumber">1</span><span class="CodeMirror-linenumber">2</span></span>
        <code class="">GRUB_ENABLE_CRYPTODISK=y
GRUB_CMDLINE_LINUX="... cryptdevice=/dev/sda2:encrypted-lvm ... cryptkey=rootfs:/root/encrypted-lvm.keyfile"
</code>
      <i><button class="clipboardButton"><svg width="13" height="13" viewBox="0 0 1792 1792"><path d="M768 1664h896v-640h-416q-40 0-68-28t-28-68v-416h-384v1152zm256-1440v-64q0-13-9.5-22.5t-22.5-9.5h-704q-13 0-22.5 9.5t-9.5 22.5v64q0 13 9.5 22.5t22.5 9.5h704q13 0 22.5-9.5t9.5-22.5zm256 672h299l-299-299v299zm512 128v672q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-160h-544q-40 0-68-28t-28-68v-1344q0-40 28-68t68-28h1088q40 0 68 28t28 68v328q21 13 36 28l408 408q28 28 48 76t20 88z"></path></svg></button></i></pre><p data-line="139">Install grub:</p>
<blockquote data-line="140">
<p data-line="140">grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=GRUB --recheck<br>
grub-mkconfig -o /boot/grub/grub.cfg</p>
</blockquote>
<h4 id="Final-Cleanup" data-line="143">Final Cleanup</h4>
<p data-line="144">Set a root password</p>
<blockquote data-line="145">
<p data-line="145">passwd<br>
Add a normal user account if desired.</p>
</blockquote>
<h3 id="Reboot-into-New-Install" data-line="148">Reboot into New Install</h3>
<blockquote data-line="150">
<p data-line="150">exit<br>
umount -R /mnt<br>
reboot</p>
</blockquote>
<p data-line="154">The system should be configured with full disk encryption and an encrypted boot partition.</p>
<h3 id="References" data-line="158">References</h3>
<ol>
<li data-line="159"><a href="https://wiki.archlinux.org/index.php/Installation_guide">Installation guide - ArchWiki</a></li>
<li data-line="160"><a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#Encrypted_boot_partition_(GRUB)">dm-crypt/Encrypting an entire system - ArchWiki</a></li>
<li data-line="161"><a href="https://computingforgeeks.com/install-arch-linux-luks-encryption/">Install Arch Linux with full hard drive encryption using luks encryption | ComputingForGeeks</a></li>
</ol>
</div></div></div></div>
<!--footer code-->
<footer>
    <a class=footer-link target="_blank" rel="noopener noreferrer" href="https://github.com/nadehi18"><i class="fab fa-github"></i></a>
    <a class=footer-link target="_blank" rel="noopener noreferrer" href="https://linkedin.com/in/nadehi18"><i class="fab fa-linkedin"></i></a>
    <a class=footer-link target="_blank" rel="noopener noreferrer" href="https://twitter.com/nadehi18"><i class="fab fa-twitter"></i></a>
</footer>
<!-- end footer code-->
</body>